- name: Update Ubuntu with latest security patches and configure firewall rules
  hosts: all
  become: true

  tasks:
  - name: Update Ubuntu
    apt:
      update_cache: yes
      upgrade: yes
      autoremove: yes

  - name: Disable automounting for CD/DVDs and USBs
    mount:
      path: /media
      src: none
      fstype: none
      opts: "noauto"
      state: present
      dump: "0"
      passno: "0"

  - name: Ensure that password is set for single user mode
    lineinfile:
      path: /etc/sysconfig/init
      regexp: '^SINGLE=/sbin/sulogin'
      line: 'SINGLE=/sbin/sulogin -p'
      state: present
      create: yes
      mode: '0644'
      backup: yes

- name: Configure stateful firewall rules on GCP Ubuntu VM
  hosts: all
  become: true

  tasks:
  - name: Set default firewall policy to deny
    ufw:
      policy: deny

  - name: Allow incoming traffic on port 22 (SSH)
    ufw:
      rule: allow
      port: 22

  - name: Allow incoming traffic on port 80 (HTTP)
    ufw:
      rule: allow
      port: 80

  - name: Allow incoming traffic on port 443 (HTTPS)
    ufw:
      rule: allow
      port: 443

  - name: Allow outbound traffic
    ufw:
      direction: outgoing
      policy: allow

- name: Set kernel tuning parameters
  hosts: all
  become: true

  tasks:
  - name: Set IP forwarding to disabled
    sysctl:
      name: net.ipv4.ip_forward
      value: 0
      state: present

  - name: Disable ICMP redirects
    sysctl:
      name: net.ipv4.conf.all.accept_redirects
      value: 0
      state: present

  - name: Disable packet redirect sending
    sysctl:
      name: net.ipv4.conf.all.send_redirects
      value: 0
      state: present

  - name: Disable source routed packets
    sysctl:
      name: net.ipv4.conf.all.accept_source_route
      value: 0
      state: present

  - name: Enable TCP SYN Cookies
    sysctl:
      name: net.ipv4.tcp_syncookies
      value: 1
      state: present

  - name: Ignore Broadcast Requests
    sysctl:
      name: net.ipv4.icmp_echo_ignore_broadcasts
      value: 1
      state: present

  - name: Enable Bad Error Message Protection
    sysctl:
      name: net.ipv4.icmp_ignore_bogus_error_responses
      value: 1
      state: present

